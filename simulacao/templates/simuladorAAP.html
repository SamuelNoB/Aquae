{% extends "base.html" %}
{% load static %}
{% load currency %}
{% load widget_tweaks %}
{% load humanize %}
{% block content %}
        <section class="clean-block features" style="border-top-style: solid;padding: 0;background: rgb(207,231,248);">
            <div class="container" style="background: #eeeeee;padding-bottom: 100px;">
                <div class="block-heading" style="padding: 40px 0px 0px;">
                    <h2 class="text-info" style="font-weight: 800;">Aproveitamento de águas pluviais</h2>
                </div>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:home' %}"><span>Home</span></a></li>
                    <li class="breadcrumb-item"><a href="{% url 'simulacao:edificacao' %}"><span>Características gerais</span></a></li>
                    <li class="breadcrumb-item"><a href="{% url 'simulacao:seleciona_simulacao' pk %}"><span>selecionar simulação</span></a></li>
                    <li class="breadcrumb-item"><a href="#"><span>Simulação AAP</span></a></li>
                </ol>
                <div class="row align-content-center" style="border: 1px none rgb(33,37,41);background: #eeeeee;margin-left: 0;margin-right: 0;">
                    <div class="col-md-5">
                        <form id="simulacaoForm" method="post">
                         {% csrf_token %}
                            <div style="margin-bottom: 1em;padding-bottom: .5em;">
                                <h4 style="font-weight: bold;">Visualização do gráfico</h4>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text">Intervalo</span></div>
                                    {% render_field simulacaoForm.intervalos_de_cisterna class="form-control" %}
                                    <div class="input-group-append"><button id="change_interval" class="btn btn-primary" type="button">Alterar</button></div>
                                </div><small class="form-text text-muted">Intervalos em m³ da cisterna a ser mostrado na aba financeiro e no gráfico.</small>
                            </div>
                            <h4 style="font-weight: bold;">Análise financeira</h4>
                            <div class="input-group d-md-flex" style="margin-bottom: 0.8em;">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" style="font-weight: bold;">{{ simulacaoForm.taxa_de_juros.label }}</span>
                                </div>
                                {% render_field simulacaoForm.taxa_de_juros class="form-control" type="number" data-toggle="tooltip"  step=".2" %}
                                <div class="input-group-append">
                                    <span class="text-break input-group-text" style="font-weight: bold;">
                                        %
                                    </span>
                                </div><small class="form-text text-muted">Adicione uma taxa de júros para ser calculada juntamente a simulação financeira</small>
                            </div>

                            <h4 style="font-weight: bold;">Demanda de água pluvial</h4>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th data-checkbox="true"></th>
                                        <th>Nome</th>
                                        <th>Consumo</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {{ demandas_de_agua.management_form }}
                                    {% for demanda in demandas_de_agua %}
                                        <tr>
                                            <td>
                                                <div class="form-check">
                                                    {{ demanda.ativo }}
                                                    <label class="form-check-label"></label>
                                                </div>
                                            </td>
                                            <td>{% render_field demanda.nome_consumo class="form-control" readonly="" size="20" style="font-weight: bold;" %}</td>
                                            <td>
                                                <div class="input-group d-md-flex">
                                                    <div class="input-group-prepend"></div>{% render_field demanda.demanda_mensal  class="form-control" data-toggle="tooltip" data-bss-tooltip="" data-placement="bottom" readonly=""  %}
                                                    <div class="input-group-append"><span class="text-break input-group-text">m³/mês<br></span></div>
                                                </div><br>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            </form>
                        </div>
                    <div class="col-md-7" style="border-top: 1px solid #dee2e6 ;border-left: 1px solid rgb(222,226,230) ;">
                        <h4 style="font-weight: 700;">Resultados</h4>
                        <div>
                            <div><canvas id="simulacao_chart"></canvas></div>
                            <p>MEP* - Máxima Economia Possível</p>
                        </div>

                        <div>
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item" role="presentation"><a class="nav-link active" role="tab" data-toggle="tab" href="#tab-3">Geral</a></li>
                                <li class="nav-item" role="presentation"><a class="nav-link" role="tab" data-toggle="tab" href="#tab-4">Dimensionamento</a></li>
                                <li class="nav-item" role="presentation"><a class="nav-link" role="tab" data-toggle="tab" href="#tab-5">Financeiro</a></li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active" role="tabpanel" id="tab-3" style="background: #ffffff;">
                                    <ul class="list-group text-capitalize" style="background: var(--secondary);">
                                        <li class="list-group-item" style="color: var(dark);background: #e1e1e1;border-style: solid;"><span style="color: var(--dark);background: #e1e1e1;font-weight: 600;">Oferta: </span>{{ geral_data.oferta_anual }} <span class="text-lowercase">m³/ano</span></li>
                                        <li class="list-group-item" style="background: #e1e1e1;"><span style="color: var(--dark);background: #e1e1e1;font-weight: 600;">Demanda: </span>{{ geral_data.demanda_total }} <span class="text-lowercase">m³/ano</span><br></li>
                                        <li class="list-group-item" style="background: #e1e1e1;"><span style="color: var(--dark);background: #e1e1e1;font-weight: 600;">Área de coleta: </span>{{ geral_data.area_cobertura }} <span class="text-lowercase">m²</span><br></li>
                                        <li class="list-group-item" style="background: #e1e1e1;"><span style="color: var(--dark);font-weight: 600;background: #e1e1e1;border-color: var(--dark);">Custo de operação: </span>{{ geral_data.custo_operacional | currency }} / ano</li>
                                    </ul>
                                </div>
                                <div class="tab-pane" role="tabpanel" id="tab-4">
                                    <ul class="list-group text-capitalize" style="background: #e1e1e1;">
                                        <li class="list-group-item" style="background: #e1e1e1;color: var(--dark);"><span style="background: #e1e1e1;color: var(--dark);font-weight: 600;">Freio d'água: </span>{{ dimensionamento.freio_dagua }}<span class="text-lowercase">mm</span></li>
                                        <li class="list-group-item" style="background: #e1e1e1;color: var(--dark);;"><span style="background: #e1e1e1;color: var(--dark);font-weight: 600;">Sifão ladrão: </span>{{ dimensionamento.sifao_ladrao }}<span class="text-lowercase">mm</span></li>
                                        <li class="list-group-item" style="background: #e1e1e1;color: var(--dark);"><span style="background: #e1e1e1;color: var(--dark);font-weight: 600;">Capacidade do filtro: </span>Até {{ dimensionamento.filtro_dagua }}<span class="text-lowercase">m² de cobertura</span></li>
                                        <li class="list-group-item" style="background: #e1e1e1;color: var(--dark);"><span style="background: #e1e1e1;color: var(--dark);font-weight: 600;">Bomba d'água Sucção: </span>{{ dimensionamento.succao }}<span class="text-lowercase">mm</span></li>
                                        <li class="list-group-item" style="background: #e1e1e1;color: var(--dark);"><span style="background: #e1e1e1;color: var(--dark);font-weight: 600;">Bomba d'água Recalque: </span>{{ dimensionamento.recalque }}<span class="text-lowercase">mm</span></li>
                                        <li class="list-group-item" style="background: #e1e1e1;color: var(--dark);"><span style="background: #e1e1e1;color: var(--dark);font-weight: 600;">Bomba d'água potência: </span>{{ dimensionamento.potencia }}<span class="text-lowercase">cv</span></li>
                                        <li class="list-group-item" style="background: #e1e1e1;color: var(--dark);"><span style="background: #e1e1e1;color: var(--dark);font-weight: 600;">Reservatório de distribuição: </span>{{ dimensionamento.reservatorio }}<span class="text-lowercase">l</span></li>
                                    </ul>
                                </div>
                                <div class="tab-pane" role="tabpanel" id="tab-5" style="background: #e1e1e1;">
                                    <div class="table-responsive" style="border-left-color: var(--secondary);">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Cisterna (m³)</th>
                                                    <th data-bss-tooltip data-toggle="tooltip" data-original-title="Valor da economia anual gerada com o sistema">Benefício (R$/ano)</th>
                                                    <th data-bss-tooltip data-toggle="tooltip" data-original-title="Custo médio de implementação do sistema">Custo (R$)</th>
                                                    <th data-bss-tooltip data-toggle="tooltip" data-original-title="Razão entre o custo e o benefício anual Custo ÷ Benefício">Payback (Ano)</th>
                                                    <th data-bss-tooltip data-toggle="tooltip" data-original-title="Valor presente Líquido, calculado para 30 anos">VPL<br>(R$)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            {% for volume, beneficio, custo, payback, vpl in tabela_data %}
                                                {% ifnotequal volume 0 %}
                                                <tr>
                                                    <td>{{ volume }}</td>
                                                    <td>{{ beneficio|currency }}</td>
                                                    <td>{{ custo|currency }}</td>
                                                    <td>{{ payback }}</td>
                                                    <td>{{ vpl|currency }}</td>
                                                </tr>
                                                {% endifnotequal %}
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
{% endblock content %}

{% block scripts %}
<script>

(function() {
var originalLineDraw = Chart.controllers.line.prototype.draw;
Chart.helpers.extend(Chart.controllers.line.prototype, {
  draw: function() {
    originalLineDraw.apply(this, arguments);

    var chart = this.chart;
    var ctx = chart.chart.ctx;

    var index = chart.config.data.lineAtIndex;
    if (index) {
      var xaxis = chart.scales['x-axis-0'];
      var yaxis = chart.scales['y-axis-0'];

      ctx.save();
      ctx.beginPath();
      ctx.moveTo(xaxis.getPixelForValue(undefined, index), yaxis.top);
          ctx.strokeStyle = '#0d1f6d';
      ctx.lineTo(xaxis.getPixelForValue(undefined, index), yaxis.bottom);
      ctx.stroke();
      ctx.restore();
    }
  }
});

    var ctx = document.getElementById('simulacao_chart');
    const labels = [{% for volume in grafico_data.volumes %}'{{ volume }}',{% endfor %}];
    const data = [{% for economia in grafico_data.economias %}{{ economia }},{% endfor %}];
    for (let i = 0; i < 3; i++) {
        const newlabel = parseInt(labels[labels.length-1]) + 5;
        labels.push(newlabel);
        data.push(data[data.length-1]);
    }
    var simulacao_chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Economia de agua potável',
                data: data,
                fill: false,
                backgroundColor: 'rgb(65,125,178)',
                borderColor: 'rgb(65,125,178)',
                borderWidth: 2
            }],
        //lineAtIndex: labels.length -2
        },
         options: {
            annotation: {
                annotations: [
                    {
                        type: "line",
                        mode: "vertical",
                        scaleID: "x-axis-0",
                        value: labels[labels.length -5],
                        borderColor: '#0d1f6d',
                        label: {
                          content: "MEP*",
                          enabled: true,
                          position: "center"
                    }
                    }
                ]
            },
            elements: {
                line: {
                    tension: 0 // disables bezier curves
                }
	        },

            responsive: true,
             title: {
                display: true,
                text: 'Economia anual por volume de cisterna',
              },
            plugins: {
            },
            interaction: {
              mode: 'index',
              intersect: false
            },
            scales: {
              xAxes: [{
                  scaleLabel: {
                      display: true,
                      labelString: 'Volumes de cisterna'
                }
              }],
              yAxes: [{
                  scaleLabel: {
                      display: true,
                      labelString: 'Economia de agua potável (m³/ano)'
                }
              }]
            }
         },
    });

})();

</script>
    <script src="{% static "assets/js/simulacaoAAP.js" %}"></script>

{% endblock scripts %}